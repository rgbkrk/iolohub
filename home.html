<!DOCTYPE html>
<html lang="en">
<head>
<title>#IOLO</title>
<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<link rel="import" href="node_modules/jupyter-display-area/dist/jupyter-display-area.html">
<script type="text/javascript">
    function display(message){
        var container = document.getElementById('container');
        if (! message.parent_header && ! message.parent_header.msg_id) {
            console.log("Rejected a message: ");
            console.dir(message);
            return;
        }

        // The element we'll send the jupyter message
        var node;
        var parentID = 'parentID-' + message.parent_header.msg_id;
        node = document.querySelector('#' + parentID);

        if (!node) {
            // For every new parentID append a new jupyter-display-area
            node = document.createElement('jupyter-display-area');
            node.id = parentID;
        }

        if(node.handle(message)) {
            container.appendChild(node);
            node.scrollIntoView();
        }
    }


    $(function() {

    var conn;

    if (window["WebSocket"]) {
        conn = new WebSocket("ws://{{$}}/ws");
        conn.onclose = function(evt) {
            // #IOLO
            console.log("Disconnected #IOLO")
            // TODO: Exponential backoff
            setTimeout(function(){
                conn = new WebSocket("ws://{{$}}/ws");
            }, 10*1000);
        }
        conn.onmessage = function(evt) {
            if(!evt.data || evt.data === ''){
                return;
            }
            
            try {
                message = JSON.parse(evt.data);
                display(message);
            } catch(err) {
                // #IOLO
                console.log(err);
            }
        }
    } else {
        // Browser doesn't support websockets
        console.log("Browser doesn't support websockets. :(")
    }
    });
</script>
<style type="text/css">
html {
    overflow: hidden;
}

body {
    overflow: hidden;
    padding: 0;
    margin: 0;
    width: 100%;
    height: 100%;
    background: gray;
}

#container {
    background: white;
    margin: 0;
    padding: 0.5em 0.5em 0.5em 0.5em;
    position: absolute;
    top: 0.5em;
    left: 0.5em;
    right: 0.5em;
    bottom: 3em;
    overflow: auto;
}

</style>
</head>
<body>
<div id="container"></div>
</body>
</html>
